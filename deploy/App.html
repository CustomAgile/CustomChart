<!DOCTYPE html>
<html>
<head>
    <title>Custom Chart</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("BarCalculator",{config:{calculationType:void 0,field:void 0},constructor:function(config){this.initConfig(config)},prepareChartData:function(store){var categories,seriesData,data;return"count"===this.calculationType?(data=_.countBy(store.getRange(),function(record){return record.get(this.field)},this),categories=_.keys(data),seriesData=[],_.each(data,function(value,key){seriesData.push([key,value])})):(data=_.groupBy(store.getRange(),function(record){return record.get(this.field)},this),categories=_.keys(data),seriesData=[],_.each(data,function(value,key){seriesData.push([key,_.reduce(value,function(total,r){return total+r.get("PlanEstimate")},0)])})),{categories:categories,series:[{name:this.field,type:"column",data:seriesData}]}}});
                Ext.define("BarChart",{xtype:"barchart",extend:"Rally.ui.chart.Chart",requires:["BarCalculator"],chartConfig:{chart:{type:"column"},title:{text:""},tooltip:{headerFormat:"",pointFormat:"{point.name}: <b>{point.y}</b>"},yAxis:{min:0,title:{text:""},stackLabels:{enabled:!0,style:{fontWeight:"bold",color:"gray"}}},plotOptions:{column:{stacking:"normal",dataLabels:{enabled:!1},showInLegend:!1}}},calculatorType:"BarCalculator"});
                Ext.define("PieCalculator",{config:{calculationType:void 0,field:void 0},constructor:function(config){this.initConfig(config)},prepareChartData:function(store){var categories,seriesData,data;return"count"===this.calculationType?(data=_.countBy(store.getRange(),function(record){return record.get(this.field)},this),categories=_.keys(data),seriesData=[],_.each(data,function(value,key){seriesData.push([key,value])})):(data=_.groupBy(store.getRange(),function(record){return record.get(this.field)},this),categories=_.keys(data),seriesData=[],_.each(data,function(value,key){seriesData.push([key,_.reduce(value,function(total,r){return total+r.get("PlanEstimate")},0)])})),{categories:categories,series:[{name:this.field,type:"pie",data:seriesData}]}}});
                Ext.define("PieChart",{xtype:"piechart",extend:"Rally.ui.chart.Chart",requires:["PieCalculator"],chartConfig:{chart:{type:"pie",plotBackgroundColor:null,plotBorderWidth:null,plotShadow:!1},title:{text:""},tooltip:{headerFormat:"",pointFormat:"{point.name}: <b>{point.percentage:.1f}%</b>"},plotOptions:{pie:{allowPointSelect:!0,cursor:"pointer",dataLabels:{enabled:!0,format:"<b>{point.name}</b>: {point.percentage:.1f} %",style:{color:"black"}}}}},calculatorType:"PieCalculator"});
                Ext.define("CustomChartApp",{extend:"Rally.app.App",componentCls:"app",layout:"fit",config:{defaultSettings:{types:"defect",chartType:"barchart",aggregationField:"State",aggregationType:"count"}},launch:function(){Rally.data.wsapi.ModelFactory.getModels({types:this._getTypesSetting()}).then({success:this._onModelsLoaded,scope:this})},_onModelsLoaded:function(models){this.models=_.values(models);var context=this.getContext(),modelNames=_.pluck(this.models,"typePath"),gridBoardConfig={xtype:"rallygridboard",stateful:!1,toggleState:"chart",chartConfig:this._getChartConfig(),plugins:[{ptype:"rallygridboardinlinefiltercontrol",showInChartMode:!0,inlineFilterButtonConfig:{stateful:!0,stateId:context.getScopedStateId("filters"),filterChildren:!0,modelNames:modelNames,inlineFilterPanelConfig:{quickFilterPanelConfig:{defaultFields:["ScheduleState","Owner","ModelType"]}}}},{ptype:"rallygridboardactionsmenu",menuItems:[{text:"Export to CSV...",handler:function(){window.location=Rally.ui.gridboard.Export.buildCsvExportUrl(this.down("rallygridboard").getGridOrBoard())},scope:this}],buttonConfig:{iconCls:"icon-export",toolTipConfig:{html:"Export",anchor:"top",hideDelay:0}}}],context:context,modelNames:modelNames,storeConfig:{filters:this._getFilters()}};this.add(gridBoardConfig)},_getTypesSetting:function(){return this.getSetting("types").split(",")},_getChartConfig:function(){return{xtype:this.getSetting("chartType"),chartColors:["red","blue","green","yellow"],storeType:"Rally.data.wsapi.artifact.Store",storeConfig:{models:this._getTypesSetting(),context:this.getContext().getDataContext(),limit:1/0,fetch:["FormattedID","Name","PlanEstimate","Priority","State"]},calculatorConfig:{calculationType:this.getSetting("aggregationType"),field:this.getSetting("aggregationField")}}},onTimeboxScopeChange:function(timeboxScope){this.callParent(arguments),this._addBoard()},_getFilters:function(){var queries=[],timeboxScope=this.getContext().getTimeboxScope();return this.getSetting("query")&&queries.push(Rally.data.QueryFilter.fromQueryString(this.getSetting("query"))),timeboxScope&&_.any(this.models,timeboxScope.isApplicable,timeboxScope)&&queries.push(timeboxScope.getQueryFilter()),queries}});

            Rally.launchApp('CustomChartApp', {
                name:"Custom Chart",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
