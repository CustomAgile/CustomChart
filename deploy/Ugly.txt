<!DOCTYPE html>
<html>
<head>
    <title>CustomChart-1.3.8</title>
    <!--  (c) 2017 CA Technologies.  All Rights Reserved. -->
    <!--  Build Date: Tue Dec 11 2018 22:38:17 GMT+0000 (UTC) -->

    <script type="text/javascript">
        var APP_BUILD_DATE = "Tue Dec 11 2018 22:38:17 GMT+0000 (UTC)";
        var CHECKSUM = 47474719172;
    </script>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>
    <!-- our highcharts (needed so that we can add patterns)
    <script type="text/javascript" src="/apps/2.1/lib/analytics/analytics-all.js"></script>
    -->


    <script type="text/javascript">
        Rally.onReady(function() {
            Ext.override(Rally.ui.gridboard.Export,{_getScopeParams:function(a){var b=a.store&&a.store.context||a.initialConfig&&a.initialConfig.storeConfig&&a.initialConfig.storeConfig.context||a.getContext().getDataContext();return{workspace:b.workspace,project:b.project,projectScopeDown:b.projectScopeDown,projectScopeUp:b.projectScopeUp}}}),Ext.override(Rally.data.PageableStore,{loadCanceled:!1,cancelLoad:function(){this.loadCanceled=!0},load:function(a){this.loadCanceled=!1,this.callParent(arguments)},_shouldLoadMorePages:function(a){return this.loadCanceled?!1:this.callParent(arguments)},_afterDoneLoadingAllPages:function(a,b,c,d){this.loadCanceled?(this.resumeEvents(),this.currentPage=1,this.loading=!1):this.callParent(arguments)}}),Ext.define("Utils.AncestorPiAppFilter",{alias:"plugin.UtilsAncestorPiAppFilter",mixins:["Ext.AbstractPlugin","Rally.Messageable"],extend:"Ext.Component",statics:{RENDER_AREA_ID:"utils-ancestor-pi-app-filter"},config:{renderAreaId:"utils-ancestor-pi-app-filter",publisher:!1,allowNoEntry:!0,settingsConfig:{},ancestorLabel:"With ancestor",ancestorLabelWidth:110,ownerLabel:"and owned by",ownerOnlyLabel:"Owned by",ownerLabelWidth:110,labelStyle:"font-size: medium",singleRowMinWidth:840},portfolioItemTypes:[],readyDeferred:null,piTypesDeferred:null,isSubscriber:!1,changeSubscribers:[],publishedValue:{},constructor:function(a){this.callParent(arguments),this._setupPubSub(),Ext.tip.QuickTipManager.init()},initComponent:function(){this.callParent(arguments),this.addEvents("ready","select")},init:function(a){this.cmp=a,this.cmp.on("resize",this._onCmpResize,this),this.renderArea=this.cmp.down("#"+this.renderAreaId);var b=this.cmp.getSettingsFields;this.cmp.getSettingsFields=function(){return this._getSettingsFields(b.apply(a,arguments))}.bind(this);var c=this.cmp.defaultSettings;c["Utils.AncestorPiAppFilter.enableAncestorPiFilter2"]=!1,c["Utils.AncestorPiAppFilter.projectScope"]="current",this.cmp.setDefaultSettings(c),this._addControlCmp().then({scope:this,success:function(){this._setReady()}})},notifySubscribers:function(){var a=this._getValue();_.each(this.changeSubscribers,function(b){this.publish(b,a)},this)},getFilterForType:function(a){var b,c=a.toLowerCase(),d=this._getValue();if(d.piTypePath){var e=d.piTypePath,f=d.isPiSelected,g=d.pi,h=this._piTypeAncestors(c,e);if(f&&null!=g&&null!=h){var i;i=this._propertyPrefix(c,h),i&&(b=new Rally.data.wsapi.Filter({property:i,value:g}))}else null!=g&&(b=new Rally.data.wsapi.Filter({property:"ObjectID",value:0}))}return b},getIgnoreProjectScope:function(){return this._getValue().ignoreProjectScope},_setupPubSub:function(){this.publisher?(this.subscribe(this,"registerChangeSubscriber",function(a){_.contains(this.changeSubscribers,a)||this.changeSubscribers.push(a),this.publish(a,this._getValue())},this),this.publish("reRegisterChangeSubscriber")):(this.subscriberEventName=Rally.getApp().getAppId()+this.$className,this.subscribe(this,this.subscriberEventName,function(a){this.intervalTimer&&(clearInterval(this.intervalTimer),delete this.intervalTimer),this.isSubscriber||(this.isSubscriber=!0,this._hideControlCmp()),this.publishedValue=a,this._onSelect()},this),this.publish("registerChangeSubscriber",this.subscriberEventName),this.intervalTimer=setInterval(function(){this.publish("registerChangeSubscriber",this.subscriberEventName)}.bind(this),500),this.subscribe(this,"reRegisterChangeSubscriber",function(){this.publish("registerChangeSubscriber",this.subscriberEventName)},this))},_getValue:function(){var a={};if(this._isSubscriber())a=this.publishedValue||{};else{if(this.piTypeSelector){var b=this.piTypeSelector.getRecord();if(b){var c=b.get("TypePath"),d=this.piSelector.getRecord(),e=this.piSelector.getValue();_.merge(a,{piTypePath:c,isPiSelected:!!d,pi:e})}}a.ignoreProjectScope=this._ignoreProjectScope()}return a},_setReady:function(){this.ready=!0,this.fireEvent("ready",this)},_onSelect:function(){this.ready&&this.fireEvent("select",this)},_getSettingsFields:function(a){var b=Rally.getApp().getSettings(),c=[{xtype:"rallycheckboxfield",id:"Utils.AncestorPiAppFilter.enableAncestorPiFilter2",name:"Utils.AncestorPiAppFilter.enableAncestorPiFilter2",fieldLabel:"Filter artifacts by ancestor portfolio item"},{xtype:"radiogroup",fieldLabel:"Show artifacts from",columns:1,vertical:!0,allowBlank:!1,items:[{boxLabel:"User's current project(s).",name:"Utils.AncestorPiAppFilter.projectScope",inputValue:"current",checked:"current"===b["Utils.AncestorPiAppFilter.projectScope"]},{boxLabel:"All projects in workspace.",name:"Utils.AncestorPiAppFilter.projectScope",inputValue:"workspace",checked:"workspace"===b["Utils.AncestorPiAppFilter.projectScope"]},{boxLabel:"User selectable (either current project(s) or all projects in workspace).",name:"Utils.AncestorPiAppFilter.projectScope",inputValue:"user",checked:"user"===b["Utils.AncestorPiAppFilter.projectScope"]}],listeners:{scope:this,change:function(a,b){}}}];return c=_.map(c,function(a){return _.merge(a,this.settingsConfig)},this),c.concat(a||[])},_addControlCmp:function(){var a=Ext.create("Deft.Deferred"),b={type:"hbox",align:"middle",defaultMargins:"0 10 0 0"},c=this.ownerLabelWidth;this.cmp.getWidth()<this.singleRowMinWidth&&(b="vbox",c=this.ancestorLabelWidth);var d=!1;0==this._showAncestorFilter()&&1==this._showIgnoreProjectScopeControl()&&(d=!0);var e={xtype:"container",id:"controlsArea",overflowX:"auto",layout:{type:"hbox",align:"top"},items:[{xtype:"container",id:"pubSubIndicatorArea",width:25,padding:"6 5 0 0",hidden:!this.publisher&&!this._isSubscriber(),items:[{xtype:"component",id:"publisherIndicator",html:'<span class="icon-bullhorn icon-large"></span>',hidden:!this.publisher},{xtype:"component",id:"subscriberIndicator",html:'<span class="icon-link icon-large"></span>',hidden:!this._isSubscriber()}]},{xtype:"container",id:"filtersArea",layout:b,items:[{xtype:"container",id:"ancestorFilterArea",layout:{type:"hbox",align:"middle"},items:[{xtype:"container",id:"piTypeArea",layout:{type:"hbox",align:"middle"}},{xtype:"container",id:"piSelectorArea",layout:{type:"hbox",align:"middle",padding:"0 0 0 5"}}]},{xtype:"container",id:"scopeControlArea",width:250,layout:{type:"hbox",align:"middle"},items:[{xtype:"rallycombobox",id:"ignoreScopeControl",stateful:!0,stateId:this.cmp.getContext().getScopedStateId("Utils.AncestorPiAppFilter.ignoreProjectScopeControl"),stateEvents:["select"],hidden:this._isSubscriber()||!this._showIgnoreProjectScopeControl(),displayField:"text",valueField:"value",labelStyle:this.labelStyle,labelWidth:c,fieldLabel:d?this.ownerOnlyLabel:this.ownerLabel,storeConfig:{fields:["text","value"],data:[{text:"Current Project(s)",value:!1},{text:"Any Project",value:!0}]},listeners:{scope:this,change:function(a,b){this._onSelect()}}}]}]}]};return this.renderArea&&(this.renderArea.setOverflowXY("auto","auto"),this.renderArea.add(e)),this._addTooltips(),Rally.data.util.PortfolioItemHelper.getPortfolioItemTypes().then({scope:this,success:function(b){this.portfolioItemTypes=b,!this._isSubscriber()&&this._showAncestorFilter()?(this.piTypeSelector=Ext.create("Rally.ui.combobox.PortfolioItemTypeComboBox",{xtype:"rallyportfolioitemtypecombobox",id:"Utils.AncestorPiAppFilter.piType",name:"Utils.AncestorPiAppFilter.piType",width:250,stateful:!0,stateId:this.cmp.getContext().getScopedStateId("Utils.AncestorPiAppFilter.piType"),stateEvents:["select"],fieldLabel:this.ancestorLabel,labelWidth:this.ancestorLabelWidth,labelStyle:this.labelStyle,valueField:"TypePath",allowNoEntry:!1,defaultSelectionPosition:"first",listeners:{scope:this,ready:function(b){b.addListener({scope:this,change:this._onPiTypeChange}),this._addPiSelector(b.getValue()).then({scope:this,success:function(){a.resolve()}})}}}),this.renderArea.down("#piTypeArea").add(this.piTypeSelector)):a.resolve()}}),a.promise},_addTooltips:function(){Ext.tip.QuickTipManager.register({target:"publisherIndicator",text:'This app broadcasts filter settings to any enabled ancestor filtered apps (indicated with <span class="icon-link icon-large"></span>)',showDelay:50,border:!0}),Ext.tip.QuickTipManager.register({target:"subscriberIndicator",text:'This app listens for filter settings from any enabled ancestor filter broadcast app (indicated with <span class="icon-bullhorn icon-large"></span>)',showDelay:50,border:!0})},_onCmpResize:function(a,b){var c={type:"hbox",align:"middle",defaultMargins:"0 10 0 0"};b<this.singleRowMinWidth&&(c={type:"vbox"});var d=this.renderArea.down("#filtersArea");if(d){var e=this.renderArea.down("#controlsArea"),f=d.removeAll(!1),g={xtype:"container",id:"filtersArea",layout:c,items:f,hidden:d.isHidden()};e.remove(d,!1),e.add(g)}},_hideControlCmp:function(){this.renderArea&&(this.renderArea.down("#pubSubIndicatorArea").show(),this.renderArea.down("#subscriberIndicator").show(),this.renderArea.down("#filtersArea").hide())},_onPiTypeChange:function(a,b,c){b&&(this._removePiSelector(),this._addPiSelector(b).then({scope:this,success:function(){this._setReady()}}))},_removePiSelector:function(){this.renderArea.down("#piSelectorArea").removeAll()},_addPiSelector:function(a){var b=Ext.create("Deft.Deferred");return this.piSelector=Ext.create("Rally.ui.combobox.ArtifactSearchComboBox",{id:"Utils.AncestorPiAppFilter.piSelector",width:250,labelAlign:"top",storeConfig:{models:a,autoLoad:!0,context:{project:null}},stateful:!0,stateId:this.cmp.getContext().getScopedStateId("Utils.AncestorPiAppFilter.piSelector"),stateEvents:["select"],valueField:"_ref",allowClear:!0,clearValue:null,allowNoEntry:this.allowNoEntry,noEntryValue:"",defaultSelectionPosition:null,listeners:{scope:this,select:function(a,b){this._onSelect()},ready:function(a,c){b.resolve()}}}),Ext.override(this.piSelector,{saveState:function(){var a,b=this,c=b.stateful&&b.getStateId(),d=b.hasListeners;c&&(a=b.getState()||{},d.beforestatesave&&b.fireEvent("beforestatesave",b,a)===!1||(Ext.state.Manager.set(c,a),d.statesave&&b.fireEvent("statesave",b,a)))}}),this.renderArea.down("#piSelectorArea").add(this.piSelector),b.promise},_showAncestorFilter:function(){return this.cmp.getSetting("Utils.AncestorPiAppFilter.enableAncestorPiFilter2")},_showIgnoreProjectScopeControl:function(){return"user"==this.cmp.getSetting("Utils.AncestorPiAppFilter.projectScope")},_ignoreProjectScope:function(){var a=!1;return this._showIgnoreProjectScopeControl()?a=this.renderArea.down("#ignoreScopeControl").getValue():"workspace"==this.cmp.getSetting("Utils.AncestorPiAppFilter.projectScope")&&(a=!0),a},_isSubscriber:function(){return this.isSubscriber},_propertyPrefix:function(a,b){var c;return"hierarchicalrequirement"===a||"userstory"===a?c=b[0].get("Name"):"defect"===a?c="Requirement."+b[0].get("Name"):a.startsWith("portfolioitem")&&(c="Parent"),c&&_.forEach(b.slice(1),function(a){c+=".Parent"},this),c},_piTypeAncestors:function(a,b){var c,d,e=null;return _.contains(["hierarchicalrequirement","userstory","defect"],a)?(c=_.findIndex(this.portfolioItemTypes,function(a){return a.get("TypePath").toLowerCase()===b.toLowerCase()}),e=this.portfolioItemTypes.slice(0,c+1)):a.startsWith("portfolioitem")&&(d=_.findIndex(this.portfolioItemTypes,function(b){return b.get("TypePath").toLowerCase()===a.toLowerCase()}),c=_.findIndex(this.portfolioItemTypes,function(a){return a.get("TypePath").toLowerCase()===b.toLowerCase()}),c>d&&(e=this.portfolioItemTypes.slice(d+1,c+1))),e}}),Rally.ui.renderer.GridEditorFactory.editorRenderers.PreliminaryEstimate=function(a){return{xtype:"rallyrecordcontexteditor",field:{xtype:"rallycombobox",allowNoEntry:!a.required,editable:!1,name:a.name,storeConfig:{autoLoad:!0,model:a.name,remoteFilter:!0,sorters:[{property:"Value"}],listeners:{load:function(){}}}}}},Ext.define("Utils.AncestorPiInlineFilter",{override:"Rally.ui.inlinefilter.QuickFilterPanel",portfolioItemTypes:[],modelName:void 0,customFilterNamePrefix:"AncestorPiInlineFilter.",_hasPiAncestor:function(a){return _.contains(["hierarchicalrequirement","userstory","defect"],a)||a.startsWith("portfolioitem")},_pisAbove:function(a){var b=[];if(_.contains(["hierarchicalrequirement","userstory","defect"],a))b=this.portfolioItemTypes;else if(a.startsWith("portfolioitem")){var c=_.findIndex(this.portfolioItemTypes,function(b){return b.get("TypePath").toLowerCase()===a});c>=0&&c<this.portfolioItemTypes.length-1&&(b=this.portfolioItemTypes.slice(c+1))}return b},initComponent:function(){this.context||(this.context=Rally.getApp().getContext().getDataContext()),this.modelName&&(this.modelName=this.modelName.toLowerCase());var a={},b=[];if(this._hasPiAncestor(this.modelName)){var c=this._pisAbove(this.modelName);_.each(c,function(d){var e=d.get("TypePath"),f=this.customFilterNamePrefix+e,g="Portfolio Item / "+d.get("Name");a[f]={xtype:"ancestorpisearchcombobox",portfolioItemType:e,piTypesAbove:c,artifactTypeName:this.modelName,storeConfig:{context:this.context,models:e,autoLoad:!0},allowNoEntry:!0,noEntryValue:null,noEntryText:"No "+g,emptyText:"Search "+g+"s...",allowClear:!1,valueField:"ObjectUUID"},b.push({name:f,displayName:g})},this),_.merge(this.addQuickFilterConfig,{additionalFields:b},function(a,b){return _.isArray(a)?_.uniq(a.concat(b),"name"):void 0}),Ext.override(Rally.ui.inlinefilter.FilterFieldFactory,a)}this.callParent(arguments)},_createFields:function(){this.fields=_.filter(this.fields,function(a){return this._filterInvalidAncestorFilters(a)},this),this.initialFilters=_.filter(this.initialFilters,function(a){return this._filterInvalidAncestorFilters(a.name)},this),this.callParent(arguments)},_filterInvalidAncestorFilters:function(a){return!a.startsWith(this.customFilterNamePrefix)||Rally.ui.inlinefilter.FilterFieldFactory.hasOwnProperty(a)}}),Ext.define("Utils.AncestorPiSearchComboBox",{alias:"widget.ancestorpisearchcombobox",extend:"Rally.ui.combobox.ArtifactSearchComboBox",parentField:"PortfolioItem.Parent.",artifactTypeName:void 0,piTypesAbove:[],statics:{UUID_REGEX:/([a-fA-F0-9]{8}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{12})/},initComponent:function(){this.storeConfig.filters=[],this.value&&(this.storeConfig.filters=[{property:this.valueField,value:this.value}]),this.callParent(arguments)},getFilter:function(){var a=this.lastValue,b=this.propertyPrefix(),c=[];return a&&this.statics().UUID_REGEX.test(a)?c.push({property:b+".ObjectUUID",value:a}):c.push({property:b,value:null}),Rally.data.wsapi.Filter.or(c)},propertyPrefix:function(){var a;return"hierarchicalrequirement"===this.artifactTypeName||"userstory"===this.artifactTypeName?a=this.piTypesAbove[0].get("Name"):"defect"===this.artifactTypeName?a="Requirement."+this.piTypesAbove[0].get("Name"):this.artifactTypeName.startsWith("portfolioitem")&&(a="Parent"),a&&_.forEach(this.piTypesAbove,function(b){return b.get("TypePath").toLowerCase()==this.portfolioItemType.toLowerCase()?!1:void(a+=".Parent")},this),a}}),Ext.define("ChartUtils",{singleton:!0,getFieldForAggregationType:function(a){switch(a){case"acceptedleafcount":return"AcceptedLeafStoryCount";case"acceptedleafplanest":return"AcceptedLeafStoryPlanEstimateTotal";case"leafcount":return"LeafStoryCount";case"leafplanest":return"LeafStoryPlanEstimateTotal";case"prelimest":return"PreliminaryEstimateValue";case"refinedest":return"RefinedEstimate";case"taskest":return"Estimate";case"taskactuals":return"Actuals";default:return"PlanEstimate"}}}),Ext.define("Calculator",{config:{calculationType:void 0,field:void 0,stackField:void 0,stackValues:void 0,bucketBy:void 0},constructor:function(a){this.initConfig(a)},prepareChartData:function(a){var b,c=this._groupData(a),d=_.keys(c);if(this.stackField){var e,f=a.model.getField(this.stackField);if(this.stackValues)e=_.map(this.stackValues,function(a){return this._getDisplayValue(f,a)},this);else{var g=_.invoke(a.getRange(),"get",this.stackField);("Iteration"===this.stackField||"Release"===this.stackField)&&(g=_.sortBy(g,function(a){var b=a&&(a.StartDate||a.ReleaseStartDate||null);return new Date(b)})),e=_.unique(_.map(g,function(a){return this._getDisplayValue(f,a)},this))}var h={};return _.each(d,function(a){var b=c[a],d=_.groupBy(b,function(a){return this._getDisplayValueForField(a,this.stackField)},this);_.each(e,function(a){h[a]=h[a]||[];var b=d[a];if("count"===this.calculationType)h[a].push(b&&b.length||0);else{var c=_.reduce(b,function(a,b){var c=this._getValueFieldForCalculationType();return a+b.get(c)},0,this);h[a].push(c)}},this)},this),{categories:d,series:_.map(e,function(a){return{name:a,type:this.seriesType,data:h[a]}},this)}}return b="count"===this.calculationType?_.map(c,function(a,b){return[b,a.length]}):_.map(c,function(a,b){var c=_.reduce(a,function(a,b){var c=this._getValueFieldForCalculationType();return a+b.get(c)},0,this);return[b,c]},this),{categories:d,series:[{name:this.field,type:this.seriesType,data:b}]}},_groupData:function(a){var b=a.model.getField(this.field),c=b.getType(),d={};if("collection"===c)return _.each(a.getRange(),function(a){var b=a.get(this.field),c=b._tagsNameArray;_.isEmpty(c)?(d.None=d.None||[],d.None.push(a)):_.each(c,function(b){d[b.Name]=d[b.Name]||[],d[b.Name].push(a)})},this),d;if(d=_.groupBy(a.getRange(),function(a){return this._getDisplayValueForField(a,this.field)},this),"date"===c){var e=_.sortBy(_.compact(_.map(a.getRange(),function(a){return a.get(this.field)},this))),f=this._getDateRange(e[0],e[e.length-1]),g={};d["-- No Entry --"]&&(g["-- No Entry --"]=d["-- No Entry --"]),d=_.reduce(f,function(a,c){var e=this._getDisplayValue(b,moment(c).toDate());return a[e]=d[e]||[],a},g,this)}return d},_getDateRange:function(a,b){var c=a,d=[],e="d";for("week"===this.bucketBy?e="w":"month"===this.bucketBy?e="M":"quarter"===this.bucketBy?e="Q":"year"===this.bucketBy&&(e="y");b>=c;)d.push(c),c=moment(c).add(1,e).toDate();return d.push(b),d},_getDisplayValueForField:function(a,b){var c=a.getField(b),d=a.get(b);return this._getDisplayValue(c,d)},_getDisplayValue:function(a,b){if(!_.isDate(b)){if(_.isObject(b))return b._refObjectName;if(Ext.isEmpty(b)){var c=a.getType();return"User"===a.attributeDefinition.SchemaType?"-- No Owner --":"rating"===c||"object"===c?"None":"-- No Entry --"}return b}return this.bucketBy&&"day"!==this.bucketBy?"week"===this.bucketBy?Rally.util.DateTime.formatWithDefault(moment(b).startOf("week").toDate()):"month"===this.bucketBy?moment(b).startOf("month").format("MMM 'YY"):"quarter"===this.bucketBy?moment(b).startOf("quarter").format("YYYY [Q]Q"):"year"===this.bucketBy?moment(b).startOf("year").format("YYYY"):void 0:Rally.util.DateTime.formatWithDefault(b)},_getValueFieldForCalculationType:function(){return ChartUtils.getFieldForAggregationType(this.calculationType)}}),Ext.define("BarCalculator",{extend:"Calculator",seriesType:"bar"}),Ext.define("BarChart",{xtype:"barchart",extend:"Rally.ui.chart.Chart",requires:["BarCalculator"],config:{chartConfig:{chart:{type:"bar"},title:{text:""},yAxis:{min:0,title:{text:""},stackLabels:{enabled:!0,style:{fontWeight:"bold",color:"gray"}},reversedStacks:!1},plotOptions:{bar:{stacking:"normal",dataLabels:{enabled:!1},showInLegend:!0,colorByPoint:!1}}},calculatorType:"BarCalculator"},constructor:function(a){a=a||{},this.mergeConfig(a),this.chartConfig.plotOptions.bar.showInLegend=this.enableStacking,this.chartConfig.plotOptions.bar.colorByPoint=!this.enableStacking,this.enableStacking||(this.chartConfig.tooltip={headerFormat:"",pointFormat:"{point.name}: <b>{point.y}</b>"}),this.callParent([this.config])}}),Ext.define("ColumnCalculator",{extend:"Calculator",seriesType:"column"}),Ext.define("ColumnChart",{xtype:"columnchart",extend:"Rally.ui.chart.Chart",requires:["ColumnCalculator"],config:{chartConfig:{chart:{type:"column"},title:{text:""},yAxis:{min:0,title:{text:""},stackLabels:{enabled:!0,style:{fontWeight:"bold",color:"gray"}},reversedStacks:!1},plotOptions:{column:{stacking:"normal",dataLabels:{enabled:!1},showInLegend:!1,colorByPoint:!0}}},calculatorType:"ColumnCalculator"},constructor:function(a){a=a||{},this.mergeConfig(a),this.chartConfig.plotOptions.column.showInLegend=this.enableStacking,this.chartConfig.plotOptions.column.colorByPoint=!this.enableStacking,this.enableStacking||(this.chartConfig.tooltip={headerFormat:"",pointFormat:"{point.name}: <b>{point.y}</b>"}),this.callParent([this.config])}}),Ext.define("PieCalculator",{extend:"Calculator",seriesType:"pie"}),Ext.define("PieChart",{xtype:"piechart",extend:"Rally.ui.chart.Chart",requires:["PieCalculator"],config:{chartConfig:{chart:{type:"pie",plotBackgroundColor:null,plotBorderWidth:null,plotShadow:!1},title:{text:""},tooltip:{headerFormat:"",pointFormat:"<b>{point.name}:</b> {point.percentage:.1f}% ({point.y}/{point.total})"},plotOptions:{pie:{allowPointSelect:!0,cursor:"pointer",dataLabels:{enabled:!0,format:"<b>{point.name}:</b> {point.percentage:.1f}% ({point.y}/{point.total})",style:{color:"black"}}}}},calculatorType:"PieCalculator"},constructor:function(a){a=a||{},this.mergeConfig(a),this.callParent([this.config])}}),Ext.define("Settings",{singleton:!0,getSettingsFields:function(a){return[{name:"chartType",xtype:"rallycombobox",plugins:["rallyfieldvalidationui"],fieldLabel:"Chart Type",displayField:"name",valueField:"value",editable:!1,allowBlank:!1,store:Ext.create("Ext.data.Store",{fields:["name","value"],data:[{name:"Bar",value:"barchart"},{name:"Column",value:"columnchart"},{name:"Pie",value:"piechart"}]}),listeners:{change:function(a){a.fireEvent("chartselected",a.getValue(),a.context)}},bubbleEvents:["chartselected"],handlesEvents:{typeselected:function(){this.fireEvent("chartselected",this.getValue())}}},{name:"types",xtype:"rallycombobox",plugins:["rallyfieldvalidationui"],allowBlank:!1,editable:!1,autoSelect:!1,validateOnChange:!1,validateOnBlur:!1,fieldLabel:"Type",shouldRespondToScopeChange:!0,context:a.context,storeConfig:{model:"TypeDefinition",sorters:[{property:"DisplayName"}],fetch:["DisplayName","TypePath"],filters:[{property:"UserListable",value:!0}],autoLoad:!1,remoteSort:!1,sortOnLoad:!0,remoteFilter:!0},displayField:"DisplayName",valueField:"TypePath",listeners:{change:function(a){a.fireEvent("typeselected",a.getValue(),a.context)},ready:function(a){a.fireEvent("typeselected",a.getValue(),a.context)}},bubbleEvents:["typeselected"],readyEvent:"ready",handlesEvents:{projectscopechanged:function(a){this.refreshWithNewContext(a)}}},{name:"aggregationField",xtype:"rallyfieldcombobox",plugins:["rallyfieldvalidationui"],fieldLabel:"Aggregate By",readyEvent:"ready",allowBlank:!1,validateOnChange:!1,validateOnBlur:!1,width:300,handlesEvents:{typeselected:function(a,b){var c=Ext.Array.from(a)[0];c?this.refreshWithNewModelType(c,b):(this.store.removeAll(),this.reset())}},bubbleEvents:["fieldselected"],listeners:{change:function(a){a.getRecord()&&a.fireEvent("fieldselected",a.getRecord().get("fieldDefinition"))},ready:function(a){a.store.filterBy(function(a){var b=a.get("fieldDefinition"),c=b.attributeDefinition,d=["Tags","Milestones"];return c&&!c.Hidden&&(("COLLECTION"!==c.AttributeType||b.isMultiValueCustom())&&!b.isMappedFromArtifact||_.contains(d,b.name))});var b=Ext.Array.map(a.store.getRange(),function(b){return b.get(a.getValueField())});Ext.Array.contains(b,a.getValue())||a.setValue(b[0]),a.getRecord()&&a.fireEvent("fieldselected",a.getRecord().get("fieldDefinition"))}}},{name:"bucketBy",xtype:"rallycombobox",plugins:["rallyfieldvalidationui"],fieldLabel:"Bucket By",displayField:"name",valueField:"value",editable:!1,allowBlank:!1,store:{fields:["name","value"],data:[{name:"Day",value:"day"},{name:"Week",value:"week"},{name:"Month",value:"month"},{name:"Quarter",value:"quarter"},{name:"Year",value:"year"}]},lastQuery:"",hidden:!0,toggleVisibility:function(){"date"===this.selectedFieldType&&"piechart"!==this.selectedChartType?this.show():this.hide()},handlesEvents:{fieldselected:function(a){this.selectedFieldType=a.getType(),this.toggleVisibility()},chartselected:function(a){this.selectedChartType=a,this.toggleVisibility()}}},{name:"aggregationType",xtype:"rallycombobox",plugins:["rallyfieldvalidationui"],fieldLabel:"Aggregation Type",displayField:"name",valueField:"value",editable:!1,allowBlank:!1,width:300,store:{fields:["name","value"],data:[{name:"Accepted Leaf Story Count",value:"acceptedleafcount"},{name:"Accepted Leaf Story Plan Estimate Total",value:"acceptedleafplanest"},{name:"Count",value:"count"},{name:"Plan Estimate Total",value:"estimate"},{name:"Leaf Story Count",value:"leafcount"},{name:"Leaf Story Plan Estimate Total",value:"leafplanest"},{name:"Preliminary Estimate Total",value:"prelimest"},{name:"Refined Estimate Total",value:"refinedest"},{name:"Actuals Total",value:"taskactuals"},{name:"Estimate Total",value:"taskest"}]},lastQuery:"",handlesEvents:{typeselected:function(a){var b=Ext.Array.from(a)[0];Rally.data.ModelFactory.getModel({type:b,success:function(a){this.store.filterBy(function(b){return"count"===b.get("value")||a.hasField(ChartUtils.getFieldForAggregationType(b.get("value")))}),this.store.findRecord("value",this.getValue())||this.setValue("count")},scope:this})}}},{name:"stackField",xtype:"rallyfieldcombobox",plugins:["rallyfieldvalidationui"],fieldLabel:"Stack By",readyEvent:"ready",allowBlank:!1,allowNoEntry:!0,noEntryText:"-- No Stacking --",validateOnChange:!1,validateOnBlur:!1,width:300,hidden:!0,toggleVisibility:function(a){"piechart"===a?(this.hide(),this.select(this.store.getRange()[0])):this.show()},handlesEvents:{chartselected:function(a){this.toggleVisibility(a)},typeselected:function(a,b){var c=Ext.Array.from(a)[0];c&&this.refreshWithNewModelType(c,b)}},listeners:{ready:function(a){a.store.filterBy(function(b){var c=b.get("fieldDefinition"),d=c.attributeDefinition;return b.get(a.getValueField())===a.noEntryValue||d&&!d.Hidden&&c.hasAllowedValues()&&!_.contains(["collection"],c.getType())});var b=Ext.Array.map(a.store.getRange(),function(b){return b.get(a.getValueField())});Ext.Array.contains(b,a.getValue())||a.setValue(b[0])}}},{type:"query"}]}}),Ext.define("CustomChartApp",{extend:"Rally.app.App",componentCls:"app",layout:{type:"vbox",align:"stretch"},items:[{id:Utils.AncestorPiAppFilter.RENDER_AREA_ID,xtype:"container",layout:{type:"hbox",align:"middle",defaultMargins:"0 10 10 0"}},{id:"grid-area",xtype:"container",flex:1,type:"vbox",align:"stretch"}],config:{defaultSettings:{types:"Defect",chartType:"piechart",aggregationField:"State",aggregationType:"count",bucketBy:"",stackField:"",query:""}},launch:function(){this.getSetting("types")?(this.ancestorFilterPlugin=Ext.create("Utils.AncestorPiAppFilter",{ptype:"UtilsAncestorPiAppFilter",pluginId:"ancestorFilterPlugin",settingsConfig:{},listeners:{scope:this,ready:function(a){Rally.data.util.PortfolioItemHelper.getPortfolioItemTypes().then({scope:this,success:function(a){return this.portfolioItemTypes=a,Rally.data.wsapi.ModelFactory.getModels({types:this._getTypesSetting()})}}).then({success:this._onModelsLoaded,scope:this}).then({scope:this,success:function(){a.addListener({scope:this,select:function(){this._addChart()}}),this._addChart()}})}}}),this.addPlugin(this.ancestorFilterPlugin)):this.fireEvent("appsettingsneeded")},onResize:function(){this.callParent(arguments);var a=this.down("#grid-area"),b=this.down("rallygridboard");a&&b&&b.setHeight(a.getHeight())},searchAllProjects:function(){return this.ancestorFilterPlugin.getIgnoreProjectScope()},getSettingsFields:function(){return Settings.getSettingsFields({context:this.getContext()})},_shouldLoadAllowedStackValues:function(a){var b=a&&a.hasAllowedValues(),c=b&&(_.contains(["state","rating","string"],a.getType())||"state"===a.getAllowedValueType()||"flowstate"===a.getAllowedValueType());return c},_onModelsLoaded:function(a){var b=Ext.create("Deft.Deferred"),c=b.promise;this.models=_.values(a);var d=this.models[0],e=this._getStackingSetting(),f=e&&d.getField(e);return this._shouldLoadAllowedStackValues(f)?c=f.getAllowedValueStore().load().then({success:function(a){this.stackValues=_.invoke(a,"get","StringValue")},scope:this}):b.resolve(),c},_addChart:function(){var a=Ext.getStore("chartStore");a&&a.cancelLoad();var b=this.down("#grid-area");b.removeAll();var c=this.getContext(),d=c.getDataContext();this.searchAllProjects()&&(d.project=null);var e=["Milestones","Tags"],f=_.pluck(this.models,"typePath"),g={xtype:"rallygridboard",toggleState:"chart",height:b.getHeight(),chartConfig:this._getChartConfig(),plugins:[{ptype:"rallygridboardinlinefiltercontrol",showInChartMode:!0,inlineFilterButtonConfig:{stateful:!0,stateId:c.getScopedStateId("filters"),filterChildren:!0,modelNames:f,inlineFilterPanelConfig:{quickFilterPanelConfig:{portfolioItemTypes:this.portfolioItemTypes,modelName:f[0],defaultFields:this._getQuickFilters(),addQuickFilterConfig:{whiteListFields:e}},advancedFilterPanelConfig:{advancedFilterRowsConfig:{propertyFieldConfig:{whiteListFields:e}}}}}},{ptype:"rallygridboardactionsmenu",menuItems:[{text:"Export to CSV...",handler:function(){window.location=Rally.ui.gridboard.Export.buildCsvExportUrl(this.down("rallygridboard").getGridOrBoard())},scope:this}],buttonConfig:{iconCls:"icon-export",toolTipConfig:{html:"Export",anchor:"top",hideDelay:0}}}],context:c,modelNames:f,storeConfig:{filters:this._getFilters(),context:d}};this.gridboard=b.add(g)},_getQuickFilters:function(){var a=["Owner","State","ScheduleState"],b=this.models[0];return this.models.length>1&&a.push("ModelType"),_.filter(a,function(a){return b.hasField(a)})},_getTypesSetting:function(){return this.getSetting("types").split(",")},_getStackingSetting:function(){var a=this.getSetting("chartType");return"piechart"!==a?this.getSetting("stackField"):null},_getChartConfig:function(){var a=this.getSetting("chartType"),b=this._getStackingSetting(),c=this.stackValues,d=this.models[0],e={xtype:a,enableStacking:!!b,chartColors:["#FF8200","#F6A900","#FAD200","#8DC63F","#1E7C00","#337EC6","#005EB8","#7832A5","#DA1884","#C0C0C0"],storeConfig:{storeId:"chartStore",context:this.getContext().getDataContext(),limit:1/0,fetch:this._getChartFetch(),sorters:this._getChartSort(),pageSize:2e3},calculatorConfig:{calculationType:this.getSetting("aggregationType"),field:this.getSetting("aggregationField"),stackField:b,stackValues:c,bucketBy:"piechart"===a?null:this.getSetting("bucketBy")}};return d.isArtifact()?(e.storeConfig.models=this._getTypesSetting(),e.storeType="Rally.data.wsapi.artifact.Store"):(e.storeConfig.model=d,e.storeType="Rally.data.wsapi.Store"),e},onTimeboxScopeChange:function(){this.callParent(arguments),this._addChart()},_getChartFetch:function(){var a=this.getSetting("aggregationField"),b=this.getSetting("aggregationType"),c=this._getStackingSetting(),d=["FormattedID","Name",a];return"count"!==b&&d.push(ChartUtils.getFieldForAggregationType(b)),c&&d.push(c),_.contains(d,"Iteration")&&d.push("StartDate"),_.contains(d,"Release")&&d.push("ReleaseStartDate"),d},_getChartSort:function(){var a=this.models[0],b=a.getField(this.getSetting("aggregationField")),c=[];return b&&"collection"!==b.getType()&&b.sortable&&c.push({property:this.getSetting("aggregationField"),direction:"ASC"}),c},_getFilters:function(){var a=[],b=this.getContext().getTimeboxScope();if(this.getSetting("query")){var c=this.getSetting("query").replace(/\{user\}/g,this.getContext().getUser()._ref);a.push(Rally.data.QueryFilter.fromQueryString(c))}b&&_.any(this.models,b.isApplicable,b)&&a.push(b.getQueryFilter());var d=this.ancestorFilterPlugin.getFilterForType(this.models[0].typePath);return d&&a.push(d),a}});

               Rally.launchApp('CustomChartApp', {
                   name: 'CustomChart'
               });
        });
    </script>

    <style type="text/css">

.app {
     /* Add app styles here */
}

    </style>

</head>
<body></body>
</html>